{
  "events": {
    "EVDAV": {
      "bizlogic": {
        "notification": {
          "type": "cel",
          "cel": "{'template': 'ACCEPTANCE_CONFIRMATION', 'channel': input.serviceType == 'TRACKED24' ? 'email' : 'sms', 'recipient': input.senderEmail}"
        },
        "tracking": {
          "type": "cel",
          "cel": "{'status': 'ACCEPTED', 'location': input.acceptanceOffice, 'timestamp': input.eventTime, 'nextStep': 'IN_TRANSIT'}"
        }
      },
      "enrichment": {
        "notification": {
          "type": "composite",
          "enrichers": [
            {
              "type": "fixed",
              "inputs": [],
              "output": ["serviceDefaults"],
              "value": {"acceptanceWindow": "2_hours", "cutoffTime": "17:00"}
            },
            {
              "type": "csv",
              "inputs": [["sender", "postcode"], ["receiver", "postcode"]],
              "output": ["route_details"],
              "inputColumns": ["origin_postcode", "destination_postcode"],
              "outputColumns": ["expected_days", "route_code", "sorting_hub"],
              "value": {"routeType": "standard"},
              "keyDelimiter": ":",
              "csvFileName": "csvs/routing_matrix.csv"
            },
            {
              "type": "lookup",
              "inputs": [["acceptance", "officeCode"]],
              "output": ["officeDetails"],
              "lookup": {
                "MC01": "MountPleasantMailCentre",
                "EC02": "EastCroydonDO",
                "BH01": "BirminghamMC",
                "MN03": "ManchesterSouthDO",
                "GL04": "GlasgowMC"
              }
            },
            {
              "type": "lookup",
              "inputs": [["item", "serviceCode"]],
              "output": ["serviceLevel"],
              "lookup": {
                "TK24": "Tracked24",
                "TK48": "Tracked48",
                "SD1": "SpecialDelivery1pm",
                "SD9": "SpecialDelivery9am",
                "RM24": "RoyalMail24"
              }
            }
          ]
        }
      }
    },
    "EVIMC": {
      "bizlogic": {
        "notification": {
          "type": "cel",
          "cel": "input.serviceType in ['SD1', 'SD9'] ? {'template': 'IN_TRANSIT_UPDATE', 'channel': 'email'} : null"
        },
        "tracking": {
          "type": "cel",
          "cel": "{'status': 'IN_TRANSIT', 'currentHub': input.mailCentre, 'scanTime': input.eventTime}"
        }
      },
      "enrichment": {
        "notification": {
          "type": "composite",
          "enrichers": [
            {
              "type": "fixed",
              "inputs": [],
              "output": ["transitDefaults"],
              "value": {"updateFrequency": "hub_scan_only", "internalProcess": true}
            },
            {
              "type": "csv",
              "inputs": [["hub", "code"]],
              "output": ["hub_info"],
              "inputColumns": ["hub_code"],
              "outputColumns": ["hub_name", "region", "capacity"],
              "value": {"hubType": "sorting"},
              "keyDelimiter": ":",
              "csvFileName": "csvs/mail_centres.csv"
            },
            {
              "type": "lookup",
              "inputs": [["transit", "hubCode"]],
              "output": ["hubLocation"],
              "lookup": {
                "SWIN": "SwindonMC",
                "COVN": "CoventryMC",
                "NOTT": "NottinghamMC",
                "LEEDS": "LeedsMC",
                "EDIN": "EdinburghMC"
              }
            },
            {
              "type": "lookup",
              "inputs": [["route", "nextHub"]],
              "output": ["nextDestination"],
              "lookup": {
                "LOCAL": "DeliveryOffice",
                "REGIONAL": "RegionalHub",
                "NATIONAL": "NationalHub",
                "INTERNATIONAL": "HeathrowIDC",
                "FINAL": "LocalDeliveryUnit"
              }
            }
          ]
        }
      }
    },
    "EVGPD": {
      "bizlogic": {
        "notification": {
          "type": "cel",
          "cel": "{'template': 'OUT_FOR_DELIVERY', 'channel': 'multi', 'sms': input.recipientMobile != null, 'email': true, 'deliveryWindow': input.roundType == 'MORNING' ? '9am-1pm' : '2pm-6pm'}"
        },
        "tracking": {
          "type": "cel",
          "cel": "{'status': 'OUT_FOR_DELIVERY', 'van': input.vanNumber, 'round': input.roundCode, 'estimatedDelivery': input.plannedTime, 'stopNumber': input.dropSequence}"
        },
        "billing": {
          "type": "cel",
          "cel": "input.serviceType == 'SD1' && time.hour(input.eventTime) > 13 ? {'charge': 'LATE_DELIVERY_REFUND', 'amount': 6.85} : null"
        }
      },
      "enrichment": {
        "notification": {
          "type": "composite",
          "enrichers": [
            {
              "type": "fixed",
              "inputs": [],
              "output": ["deliveryDefaults"],
              "value": {"safePlace": "enabled", "neighbourDelivery": "allowed", "photoProof": "required"}
            },
            {
              "type": "csv",
              "inputs": [["delivery", "postcode"], ["delivery", "roundCode"]],
              "output": ["delivery_route"],
              "inputColumns": ["postcode", "round_code"],
              "outputColumns": ["postman_id", "van_reg", "depot_code", "usual_time"],
              "value": {"deliveryType": "standard"},
              "keyDelimiter": ":",
              "csvFileName": "csvs/delivery_rounds.csv"
            },
            {
              "type": "lookup",
              "inputs": [["address", "line1"], ["address", "line2"], ["address", "postcode"]],
              "output": ["deliveryPoint"],
              "lookup": {
                "10 Downing St..SW1A 2AA": "Westminster_VIP",
                "Buckingham Palace..SW1A 1AA": "RoyalDelivery",
                "1 Canada Square.Canary Wharf.E14 5AB": "CanaryWharfCommercial",
                "Old Trafford.Sir Matt Busby Way.M16 0RA": "ManchesterStadium",
                "Edinburgh Castle.Castlehill.EH1 2NG": "EdinburghHistoric"
              }
            },
            {
              "type": "lookup",
              "inputs": [["round", "type"]],
              "output": ["roundTiming"],
              "lookup": {
                "MORNING": "09:00-13:00",
                "AFTERNOON": "13:00-17:00",
                "EVENING": "17:00-20:00",
                "SATURDAY": "09:00-15:00",
                "RURAL": "08:00-16:00"
              }
            }
          ]
        }
      }
    },
    "ENKDN": {
      "bizlogic": {
        "notification": {
          "type": "cel",
          "cel": "{'template': input.deliveryType == 'SAFEPLACE' ? 'DELIVERED_SAFEPLACE' : input.deliveryType == 'NEIGHBOUR' ? 'DELIVERED_NEIGHBOUR' : 'DELIVERED_STANDARD', 'channel': 'all', 'includePhoto': input.proofPhoto != null}"
        },
        "tracking": {
          "type": "cel",
          "cel": "{'status': 'DELIVERED', 'deliveryTime': input.eventTime, 'signature': input.signature, 'location': input.deliveryLocation, 'gps': input.gpsCoords, 'proofUrl': input.proofPhoto}"
        },
        "billing": {
          "type": "cel",
          "cel": "{'event': 'DELIVERY_COMPLETE', 'charge': input.cod ? input.codAmount : 0, 'vat': input.international ? input.customsDuty : 0, 'complete': true}"
        },
        "analytics": {
          "type": "cel",
          "cel": "{'kpi': 'DELIVERY_SUCCESS', 'onTime': input.actualTime <= input.promisedTime, 'attempts': input.attemptNumber, 'customerSatisfied': input.rating >= 4}"
        }
      },
      "enrichment": {
        "notification": {
          "type": "composite",
          "enrichers": [
            {
              "type": "fixed",
              "inputs": [],
              "output": ["completionDefaults"],
              "value": {"feedbackUrl": "https://royalmail.com/feedback", "retentionDays": 90, "proofRequired": true}
            },
            {
              "type": "csv",
              "inputs": [["delivery", "postmanId"], ["delivery", "depotCode"]],
              "output": ["performance_metrics"],
              "inputColumns": ["postman_id", "depot_code"],
              "outputColumns": ["success_rate", "avg_time", "customer_rating"],
              "value": {"metricsType": "delivery"},
              "keyDelimiter": ":",
              "csvFileName": "csvs/postman_performance.csv"
            },
            {
              "type": "lookup",
              "inputs": [["proof", "type"]],
              "output": ["proofValidation"],
              "lookup": {
                "SIGNATURE": "SignatureCaptured",
                "PHOTO": "PhotoTaken",
                "SAFEPLACE": "SafePlacePhoto",
                "NEIGHBOUR": "NeighbourSignature",
                "DEPOT": "CollectedFromDepot"
              }
            },
            {
              "type": "lookup",
              "inputs": [["customer", "postcode"]],
              "output": ["regionMetrics"],
              "lookup": {
                "SW1A": "Westminster_Premium",
                "EC1A": "CityOfLondon_Business",
                "M1": "Manchester_City",
                "B1": "Birmingham_Central",
                "G1": "Glasgow_City"
              }
            }
          ]
        }
      }
    }
  }
}