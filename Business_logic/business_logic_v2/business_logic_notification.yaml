# NOTIFICATION BUSINESS LOGIC - Updated with message.MPE structure
# Version 2.0 - Updated path structure based on mentor feedback
#
# Key Changes:
# 1. All paths now prefixed with message.MPE
# 2. auxiliaryData structure changed to auxiliaryData.data array
# 3. Structure matches JSON format from scratch_1.json
#
# NOTIFICATION RULES (from Python RULES dict):
# Event    | Tracked24    | Tracked48    | SD09         | SD13
# ---------|--------------|--------------|--------------|-------------
# EVDAV    | NRA: email   | -            | NRG: both    | NRJ: sms
# EVIMC    | -            | -            | -            | -
# EVGPD    | NRB: both    | NRE: both    | NRH: both    | NRK: both
# ENKDN    | NRC: email   | NRF: sms     | NRI: sms     | NRL: both
#
# Contact types: 1=email, 2=sms/mobile
# Tracked event code format: <prefix>RS (e.g., NRARS, NRBRS, etc.)

notification:
  events:
    # EVDAV - Accepted at Depot
    # Rules: T24=email, SD09=both, SD13=sms
    EVDAV:
      bizlogic:
        type: "cel"
        cel: |
          {
            'out': (
              has(enrichment.productCategory.productCategory) && 
              has(message.MPE.manualScan.auxiliaryData.data) ?
              
              (enrichment.productCategory.productCategory == 'Tracked24' ? 
                (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                  [
                    {
                      'type': 'notification',
                      'trackedEventCode': 'NRARS',
                      'originatingTrackedEventCode': 'EVDAV',
                      'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                      'notificationDestinationType': 1,
                      'notificationRecipientType': 'R',
                      'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                      'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                      'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                    }
                  ] 
                  : []
                )
              :
              enrichment.productCategory.productCategory == 'SpecialDelivery09' ?
                (
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRGRS',
                        'originatingTrackedEventCode': 'EVDAV',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                        'notificationDestinationType': 1,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  ) +
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRGRS',
                        'originatingTrackedEventCode': 'EVDAV',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                        'notificationDestinationType': 2,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  )
                )
              :
              enrichment.productCategory.productCategory == 'SpecialDelivery13' ?
                (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                  [
                    {
                      'type': 'notification',
                      'trackedEventCode': 'NRJRS',
                      'originatingTrackedEventCode': 'EVDAV',
                      'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                      'notificationDestinationType': 2,
                      'notificationRecipientType': 'R',
                      'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                      'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                      'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                    }
                  ] 
                  : []
                )
              : []
              )
              : []
            )
          }
    
    # EVGPD - Out for Delivery
    # Rules: All products support both email and sms
    EVGPD:
      bizlogic:
        type: "cel"
        cel: |
          {
            'out': (
              has(enrichment.productCategory.productCategory) && 
              has(message.MPE.manualScan.auxiliaryData.data) ?
              
              (enrichment.productCategory.productCategory == 'Tracked24' ? 
                (
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRBRS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                        'notificationDestinationType': 1,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  ) +
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRBRS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                        'notificationDestinationType': 2,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  )
                )
              :
              enrichment.productCategory.productCategory == 'Tracked48' ?
                (
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRERS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                        'notificationDestinationType': 1,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  ) +
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRERS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                        'notificationDestinationType': 2,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  )
                )
              :
              enrichment.productCategory.productCategory == 'SpecialDelivery09' ?
                (
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRHRS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                        'notificationDestinationType': 1,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  ) +
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRHRS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                        'notificationDestinationType': 2,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  )
                )
              :
              enrichment.productCategory.productCategory == 'SpecialDelivery13' ?
                (
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRKRS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                        'notificationDestinationType': 1,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  ) +
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRKRS',
                        'originatingTrackedEventCode': 'EVGPD',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                        'notificationDestinationType': 2,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  )
                )
              : []
              )
              : []
            )
          }
    
    # ENKDN - Delivered
    # Rules: T24=email, T48=sms, SD09=sms, SD13=both
    ENKDN:
      bizlogic:
        type: "cel"
        cel: |
          {
            'out': (
              has(enrichment.productCategory.productCategory) && 
              has(message.MPE.manualScan.auxiliaryData.data) ?
              
              (enrichment.productCategory.productCategory == 'Tracked24' ? 
                (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                  [
                    {
                      'type': 'notification',
                      'trackedEventCode': 'NRCRS',
                      'originatingTrackedEventCode': 'ENKDN',
                      'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                      'notificationDestinationType': 1,
                      'notificationRecipientType': 'R',
                      'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                      'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                      'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                    }
                  ] 
                  : []
                )
              :
              enrichment.productCategory.productCategory == 'Tracked48' ?
                (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                  [
                    {
                      'type': 'notification',
                      'trackedEventCode': 'NRFRS',
                      'originatingTrackedEventCode': 'ENKDN',
                      'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                      'notificationDestinationType': 2,
                      'notificationRecipientType': 'R',
                      'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                      'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                      'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                    }
                  ] 
                  : []
                )
              :
              enrichment.productCategory.productCategory == 'SpecialDelivery09' ?
                (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                  [
                    {
                      'type': 'notification',
                      'trackedEventCode': 'NRIRS',
                      'originatingTrackedEventCode': 'ENKDN',
                      'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                      'notificationDestinationType': 2,
                      'notificationRecipientType': 'R',
                      'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                      'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                      'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                    }
                  ] 
                  : []
                )
              :
              enrichment.productCategory.productCategory == 'SpecialDelivery13' ?
                (
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_EMAILID') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRLRS',
                        'originatingTrackedEventCode': 'ENKDN',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_EMAILID')[0].value,
                        'notificationDestinationType': 1,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  ) +
                  (message.MPE.manualScan.auxiliaryData.data.exists(d, d.name == 'RECIPIENT_MOBILENO') ? 
                    [
                      {
                        'type': 'notification',
                        'trackedEventCode': 'NRLRS',
                        'originatingTrackedEventCode': 'ENKDN',
                        'notificationDestination': message.MPE.manualScan.auxiliaryData.data.filter(d, d.name == 'RECIPIENT_MOBILENO')[0].value,
                        'notificationDestinationType': 2,
                        'notificationRecipientType': 'R',
                        'eventTimestamp': message.MPE.manualScan.eventTimestamp,
                        'uniqueItemId': message.MPE.mailPiece.mailPieceBarcode.channelSegment.uniqueItemId,
                        'UPUTrackingNumber': message.MPE.mailPiece.mailPieceBarcode.channelSegment.UPUTrackingNumber
                      }
                    ] 
                    : []
                  )
                )
              : []
              )
              : []
            )
          }

